<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet"
          href="{{ url_for('static', filename='styles/main.css') }}">
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <title>Precios | Gestión de Kioscos</title>

    <style>
    .table-producto {
        justify-content: center;
        width: 90%;
        margin: 20px auto;
        font-family: Arial, sans-serif;

        max-height: calc(100vh - 200px);
        overflow-y: auto;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;

        position: relative;
        --headerH: 0px;
        --searchH: 0px;
    }
    .table-producto table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
    }
    .table-producto th,
    .table-producto td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
        vertical-align: top;
        font-size: 14px;
    }
    .table-producto thead th {
        background-color: #f4f4f4;
        font-weight: bold;
        position: sticky;
        top: calc(var(--headerH) + var(--searchH));
        z-index: 2;
    }

    .list-header{
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding-bottom: 10px;
        position: sticky;
        top: 0;
        z-index: 4;
        background-color: #eae7e7;
    }
    .list-header h2{
        margin: 0;
        font-size: 18px;
    }
    .icon-btn{
        border: none;
        background: #fff;
        border-radius: 999px;
        padding: 6px 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    .search-bar {
        display: none;
        padding-bottom: 8px;
    }
    .search-bar.is-open {
        display: block;
    }
    .search-input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
    }
    </style>
</head>
<body>
    <div id="pc-blocker">
        <h1>Lo sentimos</h1>
        <p>Esta aplicación está optimizada solo para dispositivos móviles.</p>
        <p>Por favor, ingrese desde su celular.</p>
    </div>

    <div id="mobile-app">
        <header class="app-header">
            <div class="header-icon">
                <i class='bx bx-user-circle'></i>
            </div>

            {% if session.loggedin %}
            <div class="header-greeting">
                ¡Hola, {{ session.nombre_persona }}!
            </div>
            {% else %}
            <div class="header-greeting">
                ¡Hola!
            </div>
            {% endif %}

            <div class="header-icon notif-wrapper">
                <i class='bx bx-bell' id="btnNotificaciones"></i>
                <span class="badge-alertas" id="badgeAlertas" style="display:none;">0</span>

                <div class="notif-panel" id="notifPanel" style="display:none;">
                    <div class="notif-header">
                        Precios
                    </div>
                    <div class="notif-body" id="notifBody">
                        <div class="notif-empty">Cargando alertas...</div>
                    </div>
                    <div class="notif-footer">
                        <a href="{{ url_for('alerta_vencimiento_page') }}">Ver todas</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="dashboard-body">
            <div class="table-producto">
                <div class="list-header">
                    <h2>Precios de Productos</h2>
                    <button type="button" class="icon-btn" id="toggleSearch">
                        <i class='bx bx-search'></i>
                    </button>
                </div>

                <div class="search-bar" id="productSearchBar">
                    <input type="text"
                           id="productSearch"
                           class="search-input"
                           placeholder="Buscar producto, categoría o código...">
                </div>

                <table class="table">
      <thead>
          <tr>
              <th>#</th>
              <th>Ver lotes</th>
              <th>Nombre</th>
              <th>Categoría</th>
              <th>Precio Compra (prom.)</th>
              <th>% Ganancia</th>
              <th>Precio Venta</th>
              <th>Código Barras</th>
              <th>Ubicación FEFO</th>
              <th>Próx. Venc.</th>
              <th>Lotes con stock</th>
              <th>Stock total</th>
          </tr>
      </thead>
      <tbody>
      {% if productos %}
          {% for prod in productos %}
          <!-- Fila resumen -->
          <tr class="prod-row" data-id-producto="{{ prod.id_producto }}">
              <td>{{ loop.index }}</td>
              <td>
                  {% if (prod.lotes_con_stock or 0) > 0 %}
                    <button type="button" class="btn-add-product btn-ver-lotes">
                        Ver lotes
                    </button>
                  {% else %}
                    -
                  {% endif %}
              </td>
              <td>{{ prod.nombre or 'N/A' }}</td>
              <td>{{ prod.categoria or 'N/A' }}</td>

              <td>
                  {% if prod.costo_promedio is not none %}
                      ${{ "%.2f"|format((prod.costo_promedio or 0)|float) }}
                  {% else %}
                      -
                  {% endif %}
              </td>

              <td>{{ "%.2f"|format((prod.porcentajeganancia or 0)|float) }}%</td>
              <td>${{ "%.2f"|format((prod.precioventa or 0)|float) }}</td>
              <td>{{ prod.codigobarras or '-' }}</td>
              <td>{{ prod.ubicacion_fefo or '-' }}</td>

              <td>
                  {% if prod.prox_vencimiento %}
                      {{ prod.prox_vencimiento }}
                  {% else %}
                      -
                  {% endif %}
              </td>

              <td>{{ prod.lotes_con_stock or 0 }}</td>
              <td>{{ prod.stock_total or 0 }}</td>

              
          </tr>

          <!-- Fila oculta para detalle de lotes -->
          <tr class="det-lotes-row" data-parent-id="{{ prod.id_producto }}" style="display:none;">
              <td colspan="12">
                  <div class="lotes-panel" data-id-producto="{{ prod.id_producto }}">
                      <div class="lotes-body">
                          Cargando lotes...
                      </div>
                  </div>
              </td>
          </tr>
          {% endfor %}
      {% else %}
          <tr>
              <td colspan="12" style="text-align:center;">No hay productos registrados.</td>
          </tr>
      {% endif %}
      </tbody>
  </table>


            </div>
            <section class="block-title"></section>
            <section class="block-coupons"></section>

        </main>

        <div class="navbar">
            <div class="effect"></div>

            <button data-url="{{ url_for('main_screen') }}">
                <i class='bx bx-home'></i>
                <span>Inicio</span>
            </button>

            <button data-url="{{ url_for('producto_page') }}">
                <i class='bx bxs-box'></i>
                <span>Productos</span>
            </button>

            <button class="plus scanner-btn"
                    data-url="{{ url_for('scanner_page') }}">
                <i class='bx bxs-scan-barcode'></i>
                <span>Escaner</span>
            </button>

            <button data-url="{{ url_for('precios_page') }}">
                <i class='bx bxs-file-report'></i>
                <span>Precios</span>
            </button>

            <button data-url="{{ url_for('ajustes_page') }}">
                <i class='bx bxs-cog'></i>
                <span>Ajustes</span>
            </button>
        </div>
    </div>

    <script>
    // botón del escáner en navbar
    document.addEventListener('DOMContentLoaded', function() {
        const scannerBtn = document.querySelector('.scanner-btn');
        if (scannerBtn) {
            scannerBtn.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                window.location.href = url;
            });
        }

        navButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            const url = btn.dataset.url;
            if (url) {
              window.location.href = url;
            }
          });
        });
    });

    // === Lógica Ver Lotes ===
    const verLotesButtons = document.querySelectorAll('.btn-ver-lotes');

    verLotesButtons.forEach(btn => {
        btn.addEventListener('click', function () {
            const row = this.closest('.prod-row');
            const idProducto = row.dataset.idProducto;
            const detalleRow = document.querySelector(
                '.det-lotes-row[data-parent-id="' + idProducto + '"]'
            );
            const panel = detalleRow.querySelector('.lotes-panel');
            const body = panel.querySelector('.lotes-body');

            // si ya está visible, lo ocultamos
            if (detalleRow.style.display === '' || detalleRow.style.display === 'table-row') {
                detalleRow.style.display = 'none';
                return;
            }

            // si todavía no cargamos nada real (texto default), pedimos a la API
            if (!panel.dataset.loaded) {
                body.textContent = 'Cargando lotes...';

                fetch('/api/productos/' + idProducto + '/lotes')
                    .then(r => {
                        if (!r.ok) throw new Error('Error de red');
                        return r.json();
                    })
                    .then(data => {
                        if (data.status !== 'ok') {
                            body.textContent = 'Error al cargar lotes.';
                            return;
                        }

                        const lotes = data.lotes || [];

                        if (!lotes.length) {
                            body.textContent = 'No hay lotes registrados para este producto.';
                            panel.dataset.loaded = '1';
                            return;
                        }

                        // Construimos una mini tabla de lotes
                        let html = `
                        <table class="table table-lotes">
                            <thead>
                                <tr>
                                    <th>Lote</th>
                                    <th>Proveedor</th>
                                    <th>Cantidad</th>
                                    <th>Precio costo</th>
                                    <th>F. ingreso</th>
                                    <th>F. vencimiento</th>
                                    <th>Ubicación</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                        `;

                        lotes.forEach(l => {
                            html += `
                            <tr>
                                <td>${l.id_lote}</td>
                                <td>${l.proveedor || '-'}</td>
                                <td>${l.cantidad}</td>
                                <td>$${(l.preciocosto || 0).toFixed ? (l.preciocosto || 0).toFixed(2) : l.preciocosto}</td>
                                <td>${l.fechaingreso || '-'}</td>
                                <td>${l.fechavencimiento || '-'}</td>
                                <td>${l.ubicacion || '-'}</td>
                                <td>${l.estado || '-'}</td>
                            </tr>
                            `;
                        });

                        html += `</tbody></table>`;
                        body.innerHTML = html;
                        panel.dataset.loaded = '1';
                    })
                    .catch(err => {
                        console.error(err);
                        body.textContent = 'Error al cargar lotes: ' + err.message;
                    });
            }

            // mostrar fila de detalle
            detalleRow.style.display = 'table-row';
        });
    });

    // lógica de sticky + búsqueda
    const tableContainer = document.querySelector('.table-producto');
    const listHeader = tableContainer ? tableContainer.querySelector('.list-header') : null;
    const searchBar = tableContainer ? tableContainer.querySelector('.search-bar') : null;
    const toggleSearchBtn = document.getElementById('toggleSearch');
    const searchInput = document.getElementById('productSearch');
    const rows = tableContainer ? tableContainer.querySelectorAll('tbody tr.prod-row') : [];

    function updateTableStickyOffsets() {
        if (!tableContainer || !listHeader || !searchBar) return;
        const headerH = listHeader.offsetHeight;
        const searchH = searchBar.classList.contains('is-open') ? searchBar.offsetHeight : 0;
        tableContainer.style.setProperty('--headerH', headerH + 'px');
        tableContainer.style.setProperty('--searchH', searchH + 'px');
    }

    if (toggleSearchBtn && searchBar && searchInput && rows.length) {
        toggleSearchBtn.addEventListener('click', () => {
            const isOpen = searchBar.classList.toggle('is-open');
            toggleSearchBtn.classList.toggle('is-active', isOpen);

            setTimeout(() => {
                if (isOpen) searchInput.focus();
                updateTableStickyOffsets();
            }, 260);
        });

        searchInput.addEventListener('input', function() {
            const filtro = this.value.trim().toLowerCase();

            rows.forEach(row => {
                const textoFila = row.textContent.toLowerCase();
                if (!filtro || textoFila.includes(filtro)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    updateTableStickyOffsets();
    window.addEventListener('resize', updateTableStickyOffsets);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="{{ url_for('static', filename='javascript/main.js') }}" type="text/javascript"></script>
</body>
</html>