<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Swiper CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <!-- Estilos propios -->
    <link rel="stylesheet"
          href="{{ url_for('static', filename='styles/main.css') }}">
    <link rel="stylesheet"
          href="{{ url_for('static', filename='styles/alerta_vencimiento.css') }}">

    <!-- Iconos -->
    <link href="https://cdn.boxicons.com/fonts/basic/boxicons.min.css"
          rel="stylesheet">

    <title>Alertas de Vencimiento | Gestión de Kioscos</title>
</head>
<body>
    <!-- Bloqueador para PC -->
    <div id="pc-blocker">
        <h1>Lo sentimos</h1>
        <p>Esta aplicación está optimizada solo para dispositivos móviles.</p>
        <p>Por favor, ingrese desde su celular.</p>
    </div>

    <!-- App móvil -->
    <div id="mobile-app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-icon">
                <i class='bx bx-user-circle'></i>
            </div>

            {% if session.loggedin %}
            <div class="header-greeting">
                ¡Hola, {{ session.nombre_persona }}!
            </div>
            {% else %}
            <div class="header-greeting">
                ¡Hola!
            </div>
            {% endif %}

            <div class="header-icon notif-wrapper">
                <i class='bx bx-bell' id="btnNotificaciones"></i>
                <span class="badge-alertas" id="badgeAlertas" style="display:none;">0</span>

                <!-- Panel desplegable -->
                <div class="notif-panel" id="notifPanel" style="display:none;">
                    <div class="notif-header">
                        Alertas de vencimiento
                    </div>
                    <div class="notif-body" id="notifBody">
                        <!-- Se llena por JS -->
                        <div class="notif-empty">Cargando alertas...</div>
                    </div>
                    <div class="notif-footer">
                        <a href="{{ url_for('alerta_vencimiento_page') }}">Ver todas</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main -->
        <main class="dashboard-body">

            <div class="table-producto">
                <div class="list-header">
                    <h2>Alertas de vencimiento</h2>
                    <button type="button" class="icon-btn" id="toggleSearch">
                        <i class='bx bx-search'></i>
                    </button>
                </div>

                <div class="search-bar" id="productSearchBar">
                    <input type="text"
                           id="productSearch"
                           class="search-input"
                           placeholder="Buscar producto...">
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Oferta</th>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Precio Venta</th>
                            <th>Fecha Venc.</th>
                            <th>Días</th>
                            <th>Lote</th>
                            <th>Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% if alertas %}
                        {% for alerta in alertas %}
                        <!-- Fila principal -->
                        <tr class="alert-row"
                            data-alerta-id="{{ alerta.id_alerta }}"
                            data-id-producto="{{ alerta.id_producto }}"
                            data-precio="{{ alerta.precio_venta or 0 }}">
                            <td>{{ loop.index }}</td>

                            <!-- Botón de oferta inline -->
                            <td>
                                <button type="button"
                                        class="btn-add-product btn-oferta">
                                    Ver
                                </button>
                            </td>

                            <td>
                                <strong>{{ alerta.nombre or 'N/A' }}</strong>
                                <div class="subline">
                                    {% if alerta.dias_restantes is not none %}
                                        {% if alerta.dias_restantes > 0 %}
                                            En {{ alerta.dias_restantes }} día(s) este lote va a vencer.
                                        {% elif alerta.dias_restantes == 0 %}
                                            Este lote vence hoy.
                                        {% else %}
                                            Este lote venció hace {{ alerta.dias_restantes|abs }} día(s).
                                        {% endif %}
                                    {% else %}
                                        Sin información de días restantes.
                                    {% endif %}
                                </div>
                            </td>

                            <td>{{ alerta.categoria or 'N/A' }}</td>

                            <td>
                                ${{ "%.2f"|format((alerta.precio_venta or 0)|float) }}
                            </td>

                            <td>{{ alerta.fecha_vencimiento or 'N/A' }}</td>

                            <td>
                                {% if alerta.dias_restantes is not none %}
                                    {{ alerta.dias_restantes }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>

                            <td>{{ alerta.numero_lote or 'N/A' }}</td>
                            <td>{{ alerta.stock_lote or 0 }}</td>
                        </tr>

                        <!-- Fila desplegable (panel de oferta) -->
                        <tr class="oferta-expand"
                            data-parent-id="{{ alerta.id_alerta }}"
                            style="display:none;">
                            <td colspan="9">
                                <div class="oferta-panel"
                                     data-precio-base="{{ alerta.precio_venta or 0 }}"
                                     data-alerta-id="{{ alerta.id_alerta }}">

                                    <div class="oferta-header">
                                        <strong>Oferta sugerida para {{ alerta.nombre }}</strong>
                                    </div>

                                    <div class="oferta-text">
                                        {% if alerta.dias_restantes is not none and alerta.dias_restantes > 0 %}
                                            Este lote vence en {{ alerta.dias_restantes }} día(s).
                                            El producto en alerta se incluye siempre en el combo.
                                        {% elif alerta.dias_restantes == 0 %}
                                            Este lote vence hoy. El combo apunta a liquidar este stock.
                                        {% else %}
                                            Este lote ya está vencido; el ejemplo sirve para mostrar la lógica de ofertas.
                                        {% endif %}
                                    </div>

                                    <!-- Resumen de precios -->
                                    <div class="oferta-grid">
                                        <div>
                                            <span class="label">
                                                Precio base (producto en alerta + seleccionados):
                                            </span>
                                            <span class="valor precio-base">$0,00</span>
                                        </div>

                                        <div class="ganancia-row">
                                            <label>Ganancia (%)</label>
                                            <input type="number"
                                                   class="ganancia-input"
                                                   value="30"
                                                   min="0"
                                                   max="500"
                                                   step="1">
                                        </div>

                                        <div>
                                            <span class="label">
                                                Precio sugerido del combo/oferta:
                                            </span>
                                            <span class="valor precio-sugerido">$0,00</span>
                                        </div>
                                    </div>

                                    <!-- Tabla de productos sugeridos para combinar -->
                                    <div class="oferta-section-title" style="margin-top:10px;">
                                        Productos sugeridos para combinar
                                    </div>

                                    <table class="combo-table">
                                        <thead>
                                            <tr>
                                                <th>Incluir</th>
                                                <th>Producto</th>
                                                <th>Precio</th>
                                                <th>Stock</th>
                                                <th>Próx. Venc.</th>
                                            </tr>
                                        </thead>
                                        <tbody class="combo-body">
                                            <!-- Se llena por JS usando /api/oferta_candidatos -->
                                        </tbody>
                                    </table>

                                    <div class="oferta-footnote">
                                        El sistema propone combinaciones con otros productos de la misma categoría
                                        que tienen stock disponible. La ganancia controla el precio final del combo.
                                    </div>

                                    <button type="button"
                                            class="btn-add-product btn-oferta">
                                        Guardar oferta
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                    {% else %}
                        <tr>
                            <td colspan="9" style="text-align: center;">
                                No hay productos registrados.
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>

            <section class="block-title"></section>
            <section class="block-coupons"></section>
        </main>

        <!-- Navbar -->
        <div class="navbar">
            <div class="effect"></div>

            <button data-url="{{ url_for('main_screen') }}">
                <i class='bx bx-home'></i>
                <span>Inicio</span>
            </button>

            <button data-url="{{ url_for('producto_page') }}">
                <i class='bx bxs-box'></i>
                <span>Productos</span>
            </button>

            <button class="plus scanner-btn"
                    data-url="{{ url_for('scanner_page') }}">
                <i class='bx bxs-scan-barcode'></i>
                <span>Escaner</span>
            </button>

            <button data-url="{{ url_for('precios_page') }}">
                <i class='bx bxs-file-report'></i>
                <span>Precios</span>
            </button>

            <button data-url="{{ url_for('ajustes_page') }}">
                <i class='bx bxs-cog'></i>
                <span>Ajustes</span>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const navButtons = document.querySelectorAll('.navbar button[data-url]');

        navButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            const url = btn.dataset.url;
            if (url) {
              window.location.href = url;
            }
          });
        });

        document.querySelectorAll('.alerta-slide').forEach((slide) => {
          slide.addEventListener('click', function () {
            const url = this.dataset.url;
            if (!url) return;

            // feedback visual
            this.classList.add('is-pressed');

            // pequeño delay para que se vea el efecto
            setTimeout(() => {
              window.location.href = url;
            }, 150);
          });
        });
      });
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{{ url_for('static', filename='javascript/alerta_vencimiento.js') }}"
            type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="{{ url_for('static', filename='javascript/main.js') }}"
            type="text/javascript"></script>
</body>
</html>
